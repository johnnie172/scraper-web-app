{% extends "base.html" %}


<!DOCTYPE html>
<html lang="en">
{% block content %}
<body>

    <div class="container" >
        <h1 class="row justify-content-center my-row">Add Item</h1>
        <form class="row justify-content-center my-row form" action="/item-alert" method="post">

            <label class='col-md-2 add-item-label' for="item_url"><b>Item url</b></label>
            <input class='col-md-4 add-item-input' type="text" placeholder="Enter URL" name="item_url" required>

            <button class='col-md-2 add-item-button' type="submit">Add item</button>

          <div class="container" style="background-color:#f1f1f1">
        </form>
    </div>

        {% with messages = get_flashed_messages() %}
          {% if messages %}
            <script>
              var container = document.getElementsByClassName("container")[2];
              var messages = {{ messages | safe }};
              if (messages.length == 2) {
                var div = document.createElement("div");
                div.setAttribute("class", "alert alert-info")
                div.setAttribute("role", "alert")

                var a = document.createElement('a');  
                var link = document.createTextNode("Click to change"); 
                a.appendChild(link);
                a.title = "This is Link";
                a.href = messages[1];
                div.appendChild(a);

                container.appendChild(div);
                var dateSpan = document.createElement('span')
                dateSpan.innerHTML = messages[0];
                div.appendChild(dateSpan);
                }

            </script>
          {% endif %}
        {% endwith %}

            <h1 class="row justify-content-center my-row"> Your Items</h1>
            <div class="container" id="items">

            </div>
    <script type="text/javascript">        
    	var itemId = 0
        function appendData(data) {
		  var mainContainer = document.getElementById("items");
		  for (var i = 0; i < data.length; i++) {
		    var div = document.createElement("div");
		    div.innerHTML = 'id: ' + data[i].id + '. stock: ' + data[i].in_stock + '. lowest price: ' + data[i].lowest + '. target price: ' + data[i].target_price;


		    mainContainer.appendChild(div);
		  }
		}

        function getItems() {
        	fetch('/api/items')
        		.then(response => response.json())
        		.then(CreateTableFromJSON)
        }

        function CreateTableFromJSON(data) {

        console.log(data)
        // EXTRACT VALUE FOR HTML HEADER. 
        var col = [];
        for (var i = 0; i < data.length; i++) {
            for (var key in data[i]) {
            	if (key != 'id' && key != 'user_id') {
                if (col.indexOf(key) === -1) {
                    col.push(key);
                }}

            }
        }


        // CREATE DYNAMIC TABLE.
        var table = document.createElement("table");

        // CREATE HTML TABLE HEADER ROW USING THE EXTRACTED HEADERS ABOVE.

        var tr = table.insertRow(-1);                   // TABLE ROW.

        for (var i = 0; i < col.length; i++) {
            var th = document.createElement("th");      // TABLE HEADER.
            th.innerHTML = col[i];
            tr.appendChild(th);
        }

        // ADD JSON DATA TO THE TABLE AS ROWS.
        for (var i = 0; i < data.length; i++) {

            tr = table.insertRow(-1);

            // ADDING CELLS.
            for (var j = 0; j < col.length; j++) {
                var tabCell = tr.insertCell(-1);
                tabCell.innerHTML = data[i][col[j]];
                
                // ADDING CELLS WITH LINKS.
                if (j === 0) {
                	var urlData = data[i][col[j]]
                	tabCell.innerHTML = `<a href="${urlData}">Change</a>`;
                }

                if (j === 1) {
                	var urlData = data[i][col[j]]
                	tabCell.innerHTML = `<a href="${urlData}">Delete</a>`;
                }
            }
        }

        // ADD THE NEWLY CREATED TABLE WITH JSON DATA TO A CONTAINER.
        var divContainer = document.getElementById("items");
        divContainer.innerHTML = "";
        divContainer.appendChild(table);
    }
        function getItems() {
    	fetch('/api/items')
    		.then(response => response.json())
    		.then(CreateTableFromJSON)
        }

        getItems();


    </script>

</body>
{% endblock content %}
</html>